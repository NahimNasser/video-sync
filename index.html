<html>
<body>
	<div>
		<div>
			<h3>Welcome 
				<input id='name'></input>
				<button id="update_name">change your name</button>
			</h3>
		</div>
		<input id="video_url" type="text" placeholder="video mp4 url here"></input>
		<button id="change_url">Change video</button>
	</div>
	<div>
		<h3>People connected:</h3>
		<div id="connected_clients"></div>
	</div>
	<div id='video_area'>
		<video id='main_video' controls>
			 <source src="public/sample.mp4" type='video/mp4'>
			 <input type="range" id="seek-bar" value="0">
		</video>
	</div>

</body>
<link href="http://vjs.zencdn.net/4.3/video-js.css" rel="stylesheet">

<script src="http://vjs.zencdn.net/4.3/video.js"></script>
<script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script>
	// User stuffz
	var changeNameButton = $('#update_name');

	// Video stuffz
	var video = $('#main_video');
	var videoUrl = $('#video_url');
	var changeVideoUrl = $('#change_url');
	var videoArea = $('#video_area');


	var socket = io.connect(document.location.origin);

	function sync(data) {
		var videoStats = getPayload(video);
		if (data.src != videoStats.src) {
			changeSource(data.src);
		}
		// Might need to be refactored, this will be hit
		// n client times for each user if someone seeks
		if (Math.abs(data.time - videoStats.time) > 1) {
			video[0].currentTime = data['time'];
		}
	}
	socket.on('startup:current_video', function(data) {
		changeSource(data['src']);
	});

	socket.on('startup:name', function(data) {
		$('#name').val(data.name);
	});

	socket.on('player:pause', function(data) {
		video[0].pause();
		sync(data);
	});

	socket.on('player:play', function(data) {
		sync(data);
		video[0].play();
	});

	socket.on('player:seek', function(data) {
		video[0].pause();
		sync(data);
	});

	socket.on('player:change_src', function(data) {
		changeSource(data['src']);
	});

	socket.on('user:update:clientlist', function(data) {
		var htmlString = "<ul>";
		for (var i = 0; i < data.length; i++) {
			htmlString += "<li>";
			htmlString += "<span>" + data[i].name + "--</span><span>";
			if (data[i].ready) {
				htmlString += "Ready";
			} else {
				htmlString += "Not ready"
			}
			htmlString += "</span></li>";
		}
		htmlString += "</ul>";
		$('#connected_clients').html(htmlString);
		
	});
</script>
<script>
	var _IS_SEEKING = false;
	function changeName(newName) {
		var payload = {
			'name': newName
		};
		socket.emit('user:update:name', payload);
	}

	function getPayload(video) {
		var video = video[0];
		return {
			'src': video.currentSrc,
			'time': video.currentTime
		};
	};

	function _buildVideoElem(sourceUrl) {
	 	return "<video id='main_video' controls>" +
			"<source src=" + sourceUrl + " type='video/mp4'>" +
			"</video>";
	};

	function changeSource(sourceUrl) {
		videoArea.html(_buildVideoElem(sourceUrl));
		video = $('#main_video');
		bindVideoEvents();
	};

	function bindVideoEvents() {
		video.on('pause', function() {	
			socket.emit("player:pause", getPayload(video));
		});

		video.on('play', function() {
			socket.emit("player:play", getPayload(video));
		});

		video.on('seeked', function(data) {
			video[0].pause();
			socket.emit("player:seek", getPayload(video));	
		});
		
		video.on('canplay', function() {
			socket.emit('player:ready', getPayload(video));
		});

		changeVideoUrl.click(function() {
			var newUrl = videoUrl.val();
			changeSource(newUrl);
			socket.emit('player:change_src', {'src': newUrl});
		});
	};


	$(function() {
		changeNameButton.click(function() {
			changeName($('#name').val());
		});
		bindVideoEvents();
	});
</script>
</html>